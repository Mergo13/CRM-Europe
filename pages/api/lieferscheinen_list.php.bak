<?php
// pages/api/lieferscheinen_list.php - dynamic list (introspects columns)
require_once __DIR__ . '/../../config/db.php';
header('Content-Type: application/json; charset=utf-8');
$table = 'lieferscheinen';
$search = trim($_GET['q'] ?? '');
$status = trim($_GET['status'] ?? '');
$sort = trim($_GET['sort'] ?? 'date');
$dir = strtolower(trim($_GET['dir'] ?? 'desc')) === 'asc' ? 'ASC' : 'DESC';
$page = max(1,(int)($_GET['page'] ?? 1));
$perPage = max(5,min(200,(int)($_GET['per_page'] ?? 25)));
$offset = ($page-1)*$perPage;
try {
    $colsStmt = $pdo->prepare("SHOW COLUMNS FROM `$table`"); $colsStmt->execute();
    $cols = $colsStmt->fetchAll(PDO::FETCH_ASSOC); $colNames = array_column($cols,'Field');
    $fileCandidates = []; foreach($colNames as $c){ $lc=strtolower($c); if(in_array($lc,['file','filename','file_name','file_path','filepath','attachment','pdf','document','file_url','path','url'])) $fileCandidates[]=$c; if(preg_match('/(_file|_path|_url|_pdf)$/',$lc) && !in_array($c,$fileCandidates)) $fileCandidates[]=$c; }
} catch(Throwable $e){ http_response_code(500); echo json_encode(['error'=>'db','message'=>'introspection failed']); exit; }
$where=[]; $params=[];
if($search!==''){ $where[]='(nummer LIKE :q OR rechnungsnummer LIKE :q OR kunde LIKE :q OR beschreibung LIKE :q)'; $params[':q']='%'.$search.'%'; }
if($status!=='' && in_array('status',$colNames)){ $where[]='status = :status'; $params[':status']=$status; }
$whereSql = $where? 'WHERE '.implode(' AND ',$where):'';
$allowedSort = []; foreach($colNames as $c)$allowedSort[$c]=$c;
$sortSql = $allowedSort[$sort] ?? (in_array('created_at',$colNames)?'created_at':$colNames[0]);
try {
    $countSql = "SELECT COUNT(*) FROM `$table` $whereSql";
    $s = $pdo->prepare($countSql); $s->execute($params); $total = (int)$s->fetchColumn();
    $selectCols = implode(', ', array_map(function($c){ return "`$c`"; }, $colNames));
    $sql = "SELECT $selectCols FROM `$table` $whereSql ORDER BY $sortSql $dir LIMIT :limit OFFSET :offset";
    $s = $pdo->prepare($sql); foreach($params as $k=>$v) $s->bindValue($k,$v); $s->bindValue(':limit',$perPage,PDO::PARAM_INT); $s->bindValue(':offset',$offset,PDO::PARAM_INT); $s->execute();
    $rows = $s->fetchAll(PDO::FETCH_ASSOC);
    foreach($rows as &$r){ $r = (array)$r; $r['_file_candidates']=$fileCandidates; $r['file_url']=null; foreach($fileCandidates as $fc){ if(!empty($r[$fc])){ $val=$r[$fc]; if(preg_match('#^https?://#i',$val)) $r['file_url']=$val; elseif(is_string($val) && strlen($val)>0 && $val[0]==='/') $r['file_url']=$val; else $r['file_url'] = '/uploads/' . ltrim($val,'/'); break; } } }
    echo json_encode(['data'=>$rows,'total'=>$total,'page'=>$page,'per_page'=>$perPage], JSON_UNESCAPED_UNICODE);
    exit;
} catch(Throwable $e){ http_response_code(500); echo json_encode(['error'=>'db','message'=>'query failed']); exit; }
